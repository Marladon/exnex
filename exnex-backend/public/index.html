<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>exnex</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/cards.css">
    <link rel="stylesheet" href="/css/chat.css">

    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.js"></script>
</head>
<body>
    <!-- –ù–ê–ß–ê–õ–û –í–ê–®–ï–ì–û –ö–û–î–ê -->
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon">üéØ</span>
                <span>Exnex</span>
            </a>
            
            <div class="search-container">
                <input type="text" 
                    id="globalSearch" 
                    class="search-input" 
                    placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥..."
                    onkeypress="if(event.key === 'Enter') searchAds()">
                <button class="search-button" onclick="searchAds()">
                    üîç
                </button>
            </div>

            <div class="header-actions">
                <button class="btn btn-secondary post-ad-btn" onclick="document.getElementById('adTitle').focus()">
                    <span>+ –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
                </button>
                
                <div class="user-menu">
                    <div id="userInfo" class="user-info" style="display: none;">
                        <div class="avatar" id="userAvatar" onclick="toggleUserMenu()"></div>
                    </div>
                    <div id="authButtons">
                        <button class="btn btn-outline btn-sm" onclick="showLogin()">–í–æ–π—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- –ó–ê–ö–†–´–¢–¨ –•–ï–î–ï–† –ó–î–ï–°–¨! -->

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –ó–î–ï–°–¨ -->
    <main class="container" style="padding-top: 20px;">
        <h1 style="text-align: center; margin-bottom: 30px;">üéØ Exnex - –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>
        
        <!-- –í—Ö–æ–¥ -->
        <div class="section">
            <h2>üîê –í—Ö–æ–¥</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="logout()" style="background: #dc3545;">–í—ã–π—Ç–∏</button>
            <div id="loginResult" class="error"></div>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="section">
            <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regName" placeholder="–ò–º—è">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="regResult" class="error"></div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="section">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <select id="adCategory">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
            </select>
            <input type="text" id="adTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
            <textarea id="adDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
            <input type="number" id="adPrice" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="adLocation" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
            <input type="file" id="adImages" multiple accept="image/*">
            <div id="imagePreview" style="margin: 10px 0;"></div>
            <button onclick="createAd()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="adResult" class="error"></div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="section">
            <h2>üîç –ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                <input type="number" id="minPrice" placeholder="–¶–µ–Ω–∞ –æ—Ç">
                <input type="number" id="maxPrice" placeholder="–¶–µ–Ω–∞ –¥–æ">
                <input type="text" id="locationInput" placeholder="–ì–æ—Ä–æ–¥">
                <select id="categoryFilter">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
                <select id="sortSelect">
                    <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="cheapest">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                    <option value="expensive">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
                    <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                </select>
                <button onclick="searchAds()">–ò—Å–∫–∞—Ç—å</button>
                <button onclick="resetSearch()" style="background: #6c757d;">–°–±—Ä–æ—Å</button>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="section">
            <h2>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h2>
            
            <div id="conversationsList" style="margin-bottom: 20px;">
                <button onclick="loadConversations()">üì® –ú–æ–∏ –¥–∏–∞–ª–æ–≥–∏</button>
                <div id="conversationsContainer" style="margin-top: 10px;"></div>
            </div>
            
            <div id="chatContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="chatWithUser">–î–∏–∞–ª–æ–≥ —Å...</h3>
                    <button onclick="closeChat()" style="background: #dc3545;">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                
                <div id="messagesContainer" style="
                    height: 300px; 
                    overflow-y: auto; 
                    border: 1px solid #ddd; 
                    padding: 10px; 
                    margin: 10px 0;
                    background: #f9f9f9;
                "></div>
                
                <div style="display: flex;">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;">
                    <button onclick="sendMessage()" style="margin-left: 10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
        <div class="section">
            <h2>üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <button onclick="loadAds()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <button onclick="loadFavorites()">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button onclick="loadAds()">üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
            <div id="adsContainer" class="ads-grid"></div>
        </div>
    </main>
    <!-- –ó–ê–ö–†–´–¢–¨ –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->    

    <script>
        const API_URL = 'http://localhost:3000/api';

        let authToken = localStorage.getItem('token') || null;
        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        function setAuthToken(token, user = null) {
            authToken = token;
            if (token) {
                localStorage.setItem('token', token);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket (–¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó)
                    if (window.socketManager) {
                        console.log('üîå –ò–Ω–∏—Ü–∏–∏—Ä—É—é WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                        console.log('socketManager –¥–æ connect:', window.socketManager);
                        console.log('connected –¥–æ connect:', window.socketManager.connected);

                        window.socketManager.connect(token); // ‚Üê –¢–û–õ–¨–ö–û –û–î–ò–ù –í–´–ó–û–í
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            console.log('socketManager –ø–æ—Å–ª–µ connect:', window.socketManager);
                            console.log('connected –ø–æ—Å–ª–µ connect:', window.socketManager.connected);
                            console.log('socket –ø–æ—Å–ª–µ connect:', window.socketManager.socket);
                            console.log('socket.id –ø–æ—Å–ª–µ connect:', window.socketManager.socket?.id);
                        }, 1000);

                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                        window.socketManager.onMessage((data) => {
                            console.log('üí¨ WS —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', data);
                            
                            if (!data || !data.sender_id) {
                                console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                                return;
                            }

                            const storedUser = localStorage.getItem('user');
                            const currentUserLocal = storedUser ? JSON.parse(storedUser) : null;
                            const isMyMessage = data.sender_id === currentUserLocal?.id
                            
                            // 1. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º
                            if (currentChatUserId && currentChatUserId === data.sender_id) {
                                console.log('‚úÖ –î–æ–±–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç');
                                addMessageToChat(data);
                            }
                            // 2. –ï—Å–ª–∏ —ç—Ç–æ –º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º —á–∞—Ç–µ
                            else if (currentChatUserId && isMyMessage && currentChatUserId === data.receiver_id) {
                                console.log('‚úÖ –î–æ–±–∞–≤–ª—è—é –º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç');
                                addMessageToChat(data);
                            }
                            // 3. –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç
                            else {
                                console.log('üîÑ –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤');
                                showNewMessageNotification(data);
                                
                                if (document.getElementById('conversationsList').style.display !== 'none') {
                                    setTimeout(() => loadConversations(), 500);
                                }
                            }

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            if (!isMyMessage) {
                                showMessageNotification(data);
                            }
                        });

                        function showNewMessageNotification(data) {
                            const conversationsBtn = document.querySelector('button[onclick="loadConversations()"]');
                            if (conversationsBtn) {
                                let badge = conversationsBtn.querySelector('.message-badge');
                                if (!badge) {
                                    badge = document.createElement('span');
                                    badge.className = 'message-badge';
                                    badge.style.cssText = `
                                        background: red;
                                        color: white;
                                        border-radius: 50%;
                                        padding: 2px 6px;
                                        font-size: 12px;
                                        margin-left: 5px;
                                    `;
                                    conversationsBtn.appendChild(badge);
                                }
                                
                                const current = parseInt(badge.textContent) || 0;
                                badge.textContent = current + 1;
                                badge.style.display = 'inline-block';
                            }
                        }
                    } // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç if (window.socketManager)
                } // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç if (user)
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
                
                if (window.socketManager) {
                    window.socketManager.disconnect();
                }
            }
        } // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
        let isSendingMessage = false;

        async function sendMessage() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
            if (isSendingMessage) {
                console.log('‚è≥ –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            console.log('üìù –ü—Ä–æ–≤–µ—Ä—è—é —Ç–µ–∫—Å—Ç:', text, '–¥–ª–∏–Ω–∞:', text.length);
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏
            isSendingMessage = true;
            
            try {
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
                input.value = '';
                
                console.log('‚úÖ –¢–µ–∫—Å—Ç –ø—Ä–∏–Ω—è—Ç:', text);
                
                // –í–°–ï–ì–î–ê —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (currentUser) {
                    addMessageToChat({
                        sender_id: currentUser.id,
                        sender_name: currentUser.name,
                        text: text,
                        is_read: false,
                        created_at: new Date()
                    });
                }
                
                // –ü—Ä–æ–±—É–µ–º WebSocket
                if (window.socketManager?.connected) {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —á–µ—Ä–µ–∑ WebSocket');
                    window.socketManager.sendMessage(currentChatUserId, text);
                } else {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —á–µ—Ä–µ–∑ HTTP');
                    // HTTP fallback
                    await fetch(`${API_URL}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            receiver_id: currentChatUserId,
                            text: text
                        })
                    });
                }
                
            } catch (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
            } finally {
                // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    isSendingMessage = false;
                    console.log('üîÑ –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é');
                }, 500);
            }
        }

        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º badge
        async function openChat(userId, userName) {
            console.log('üí¨ –û—Ç–∫—Ä—ã–≤–∞—é —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', userId, userName);
            
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç
            currentChatUserId = userId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('chatWithUser').textContent = `üí¨ –î–∏–∞–ª–æ–≥ —Å ${userName}`;
            document.getElementById('chatContainer').style.display = 'block';
            document.getElementById('conversationsList').style.display = 'none';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º badge —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            const badge = document.querySelector('.message-badge');
            if (badge) {
                badge.style.display = 'none';
                badge.textContent = '0';
            }
            
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ WebSocket
            if (window.socketManager && window.socketManager.connected) {
                console.log('üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è—é—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ WebSocket');
                window.socketManager.joinConversation(userId);
            }
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            document.getElementById('messageInput').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666;">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏–Ω–Ω–µ—Ä —Å—Ç–∏–ª—å
            const style = document.createElement('style');
            style.textContent = `
                .spinner {
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #007bff;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 10px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await loadMessages(userId);
                
                // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 100);
                
            } catch (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞:', err);
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                        <button onclick="loadMessages(${userId})" 
                                style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px;">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                `;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
            const messageInput = document.getElementById('messageInput');
            if (messageInput && !messageInput.hasEnterHandler) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                messageInput.hasEnterHandler = true;
            }
            
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('‚úÖ –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ID:', userId);
        }

        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        function showNotification(message) {
            if (Notification.permission === 'granted' && message.sender_id !== currentUser?.id) {
                new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.sender_name}`, {
                    body: message.text.length > 100 ? message.text.substring(0, 100) + '...' : message.text,
                    icon: '/favicon.ico'
                });
            }
        }

        let categories = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/categories`);
                const data = await res.json();
                categories = data.categories;
                 
                // –î–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
                const select = document.getElementById('adCategory');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∏—Å–∫–∞
                const filterSelect = document.getElementById('categoryFilter');
                filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                if (res.ok) {
                    setAuthToken(data.token, data.user);
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü—Ä–∏–≤–µ—Ç, ${data.user.name}`;
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        function logout() {
            setAuthToken(null);
            document.getElementById('loginResult').textContent = '‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
            document.getElementById('adUserId').value = '';
            updateAuthUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                    üë§ ${currentUser.name} (${currentUser.email})<br>
                    üÜî ID: ${currentUser.id}
                `;
                userInfo.style.color = 'green';
            } else {
                userInfo.innerHTML = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                userInfo.style.color = 'red';
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const resultDiv = document.getElementById('regResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                
                const data = await res.json();
                if (res.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setAuthToken(data.token, data.user);
                    
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.name}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        document.getElementById('adImages').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.margin = '5px';
                    img.style.borderRadius = '5px';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadImages(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('images', file);
            }
            
            try {
                const res = await fetch(`${API_URL}/upload/multiple`, {
                    method: 'POST',
                    body: formData
                    // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å boundary
                });
                const data = await res.json();
                return data.files.map(file => file.path);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
                return [];
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function createAd() {
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø –° –ö–ê–†–¢–ò–ù–ö–ê–ú–ò ===');
            
            const files = document.getElementById('adImages').files;
            const resultDiv = document.getElementById('adResult');
            
            resultDiv.textContent = '–ù–∞—á–∏–Ω–∞–µ–º...';
            resultDiv.style.color = 'blue';
            
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                let imagePaths = [];
                
                if (files.length > 0) {
                    resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫...';
                    console.log('–ó–∞–≥—Ä—É–∂–∞—é', files.length, '–∫–∞—Ä—Ç–∏–Ω–æ–∫');
                    
                    const formData = new FormData();
                    for (let file of files) {
                        formData.append('images', file);
                    }
                    
                    const uploadRes = await fetch(`${API_URL}/upload/multiple`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadRes.ok) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏');
                    }
                    
                    const uploadData = await uploadRes.json();
                    console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', uploadData);
                    imagePaths = uploadData.files.map(file => file.path);
                }
                
                // 2. –°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
                resultDiv.textContent = '–°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...';
                
                const ad = {
                    category_id: document.getElementById('adCategory').value || 1,
                    title: document.getElementById('adTitle').value,
                    description: document.getElementById('adDescription').value,
                    price: parseFloat(document.getElementById('adPrice').value) || 0,
                    location: document.getElementById('adLocation').value,
                    images: imagePaths  // –º–∞—Å—Å–∏–≤ —Å –ø—É—Ç—è–º–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);
                
                const headers = {
                    'Content-Type': 'application/json'
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);

                const res = await fetch(`${API_URL}/ads`, {
                    method: 'POST',
                    headers: headers,  // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –æ–±—ä–µ–∫—Ç headers
                    body: JSON.stringify(ad)
                });
                
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! ID: ${data.ad.id}`;
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('adImages').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('adTitle').value = '';
                    document.getElementById('adDescription').value = '';
                    document.getElementById('adPrice').value = '';
                    document.getElementById('adLocation').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadAds();
                    
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
                
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
                console.error('–û—à–∏–±–∫–∞:', err);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadAds(filters = {}) {
            currentView = 'all';
            try {
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                const params = new URLSearchParams();
                
                if (filters.search) params.append('search', filters.search);
                if (filters.min_price) params.append('min_price', filters.min_price);
                if (filters.max_price) params.append('max_price', filters.max_price);
                if (filters.location) params.append('location', filters.location);
                if (filters.category_id) params.append('category_id', filters.category_id);
                if (filters.sort) params.append('sort', filters.sort);
                
                const queryString = params.toString();
                const url = queryString ? `${API_URL}/ads?${queryString}` : `${API_URL}/ads`;
                
                console.log('–ó–∞–≥—Ä—É–∂–∞—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –∞–¥—Ä–µ—Å—É:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π');
                }
                
                const container = document.getElementById('adsContainer');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                let favoritesMap = {};
                if (authToken) {
                    try {
                        const favRes = await fetch(`${API_URL}/favorites`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        if (favRes.ok) {
                            const favData = await favRes.json();
                            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É {adId: true} –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                            favData.favorites?.forEach(fav => {
                                favoritesMap[fav.id] = true;
                            });
                        }
                    } catch (err) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', err);
                    }
                }
                
                if (!data.ads || data.ads.length === 0) {
                    container.innerHTML = '<p>–û–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }
                
                container.innerHTML = data.ads.map(ad => `
                    <div class="ad-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>${ad.title}</h3>
                            <button onclick="toggleFavorite(${ad.id})" 
                                    id="fav-btn-${ad.id}" 
                                    style="background: none; border: none; font-size: 1.5em; cursor: pointer; 
                                        color: ${favoritesMap[ad.id] ? 'red' : 'gray'}">
                                ${favoritesMap[ad.id] ? '‚ô•' : '‚ô°'}
                            </button>
                        </div>
                        ${ad.images && ad.images.length > 0 ? 
                        `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                        : ''}
                        <p>${ad.description.substring(0, 100)}${ad.description.length > 100 ? '...' : ''}</p>
                        <div class="ad-price">${ad.price ? ad.price + ' ‚ÇΩ' : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'}</div>
                        <p><small>üìç ${ad.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</small></p>
                        <p><small>üë§ ${ad.user_name || '–ê–Ω–æ–Ω–∏–º'}</small></p>
                        ${currentUser && currentUser.id && ad.user_id && currentUser.id !== ad.user_id ? 
                        `<button onclick="startChat(${ad.user_id}, '${escapeHtml(ad.user_name)}', ${ad.id}, '${escapeHtml(ad.title)}')" 
                                style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-top: 5px; cursor: pointer; font-size: 0.9em;">
                            üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
                        </button>` : ''}
                        <p><small>üìÅ ${ad.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</small></p>
                        <p><small>üëÅÔ∏è ${ad.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small></p>
                        <p><small>üìÖ ${new Date(ad.created_at).toLocaleDateString()}</small></p>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', err);
                const container = document.getElementById('adsContainer');
                container.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
            }
        }

        function searchAds() {
            const filters = {
                search: document.getElementById('searchInput').value,
                min_price: document.getElementById('minPrice').value,
                max_price: document.getElementById('maxPrice').value,
                location: document.getElementById('locationInput').value,
                category_id: document.getElementById('categoryFilter').value,
                sort: document.getElementById('sortSelect').value
            };
            
            loadAds(filters);
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortSelect').value = 'newest';
            
            loadAds(); // –∑–∞–≥—Ä—É–∂–∞–µ–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            const savedUser = localStorage.getItem('user');
            const savedToken = localStorage.getItem('token');

            if (savedUser && savedToken) {
                const user = JSON.parse(savedUser);
                setAuthToken(savedToken, user); // ‚Üê —ç—Ç–æ –ø–æ–¥–∫–ª—é—á–∏—Ç WebSocket
            }
            
            updateAuthUI();  // ‚Üê –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            loadCategories();
            loadAds();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function toggleFavorite(adId) {
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                return;
            }
            
            const button = document.getElementById(`fav-btn-${adId}`);
            
            try {
                const checkRes = await fetch(`${API_URL}/favorites/check/${adId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const checkData = await checkRes.json();
                
                if (checkData.is_favorite) {
                    // –£–¥–∞–ª—è–µ–º
                    const res = await fetch(`${API_URL}/favorites/${adId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        if (button) {
                            button.innerHTML = '‚ô°';
                            button.style.color = 'gray';
                        }
                        // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                        if (currentView === 'favorites') {
                            setTimeout(() => loadFavorites(), 100);
                        }
                    }
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º
                    const res = await fetch(`${API_URL}/favorites/${adId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        if (button) {
                            button.innerHTML = '‚ô•';
                            button.style.color = 'red';
                        }
                    }
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function loadFavorites() {
            currentView = 'favorites';
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/favorites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('adsContainer');
                container.innerHTML = '<h2>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>' + 
                    (data.favorites && data.favorites.length > 0 ? 
                        data.favorites.map(ad => `
                            <div class="ad-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3>${ad.title}</h3>
                                    <button onclick="toggleFavorite(${ad.id})" 
                                            style="color: red; background: none; border: none; font-size: 1.5em; cursor: pointer;">
                                        ‚ô•
                                    </button>
                                </div>
                                ${ad.images && ad.images.length > 0 ? 
                                `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                                : ''}
                                <p>${ad.description.substring(0, 100)}${ad.description.length > 100 ? '...' : ''}</p>
                                <div class="ad-price">${ad.price ? ad.price + ' ‚ÇΩ' : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'}</div>
                                <p><small>üìç ${ad.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</small></p>
                                <p><small>üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(ad.favorited_at).toLocaleDateString()}</small></p>
                            </div>
                        `).join('') :
                        '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô ==========
        let currentChatUserId = null;

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏
        async function loadConversations() {
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/messages/conversations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await res.json();
                const container = document.getElementById('conversationsContainer');
                
                if (!data.conversations || data.conversations.length === 0) {
                    container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p>';
                    return;
                }
                
                container.innerHTML = data.conversations.map(conv => {
                    const otherUserId = conv.sender_id === currentUser.id ? conv.receiver_id : conv.sender_id;
                    return `
                        <div style="
                            padding: 10px; 
                            border: 1px solid #ddd; 
                            margin: 5px 0; 
                            cursor: pointer;
                            border-radius: 5px;
                            background: ${conv.unread_count > 0 ? '#e8f4fd' : 'white'};
                        " onclick="openChat(${otherUserId}, '${escapeHtml(conv.other_user_name)}')">
                            <strong>${escapeHtml(conv.other_user_name)}</strong>
                            <p style="color: #666; font-size: 0.9em; margin: 5px 0;">
                                ${escapeHtml(conv.text.length > 50 ? conv.text.substring(0, 50) + '...' : conv.text)}
                            </p>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #888;">
                                <span>${new Date(conv.created_at).toLocaleDateString()}</span>
                                ${conv.unread_count > 0 ? 
                                `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px;">
                                    ${conv.unread_count}
                                </span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤:', err);
                document.getElementById('conversationsContainer').innerHTML = 
                    '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤</p>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç
        function closeChat() {
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('conversationsList').style.display = 'block';
            currentChatUserId = null;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
        async function loadMessages(userId) {
            try {
                const res = await fetch(`${API_URL}/messages/conversation/${userId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await res.json();
                const container = document.getElementById('messagesContainer');
                
                if (!data.messages || data.messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
                    return;
                }
                
                container.innerHTML = data.messages.map(msg => `
                    <div style="
                        margin: 10px 0;
                        text-align: ${msg.sender_id === currentUser.id ? 'right' : 'left'};
                    ">
                        <div style="
                            display: inline-block;
                            max-width: 70%;
                            padding: 8px 12px;
                            border-radius: 15px;
                            background: ${msg.sender_id === currentUser.id ? '#007bff' : '#e9ecef'};
                            color: ${msg.sender_id === currentUser.id ? 'white' : 'black'};
                            text-align: left;
                        ">
                            <div style="font-size: 0.9em; margin-bottom: 5px;">
                                <strong>${escapeHtml(msg.sender_name)}</strong>
                                ${msg.ad_title ? `<br><small>–û–±—ä—è–≤–ª–µ–Ω–∏–µ: ${escapeHtml(msg.ad_title)}</small>` : ''}
                            </div>
                            <div>${escapeHtml(msg.text)}</div>
                            <div style="font-size: 0.7em; opacity: 0.7; margin-top: 5px;">
                                ${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                ${msg.is_read && msg.sender_id === currentUser.id ? ' ‚úì‚úì' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
                container.scrollTop = container.scrollHeight;
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
                document.getElementById('messagesContainer').innerHTML = 
                    '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
            }
        }

        // –ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º
        async function startChat(userId, userName, adId = null, adTitle = null) {
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            currentChatUserId = userId;
            document.getElementById('chatWithUser').textContent = `–î–∏–∞–ª–æ–≥ —Å ${userName}`;
            document.getElementById('chatContainer').style.display = 'block';
            document.getElementById('conversationsList').style.display = 'none';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (adId && adTitle) {
                document.getElementById('messageInput').value = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å –≤–∞—à–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º "${adTitle}"`;
            }
            
            await loadMessages(userId);
        }
        // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô ==========

        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            if (!container) {
                console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const storedUser = localStorage.getItem('user');
            const currentUserLocal = storedUser ? JSON.parse(storedUser) : null;
            const isMyMessage = message.sender_id === currentUserLocal?.id;
            
            console.log('‚ûï –î–æ–±–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ:', {
                sender: message.sender_name,
                isMyMessage: isMyMessage,
                text: message.text.substring(0, 50)
            });
            
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `
                <div style="
                    margin: 10px 0;
                    text-align: ${isMyMessage ? 'right' : 'left'};
                ">
                    <div style="
                        display: inline-block;
                        max-width: 70%;
                        padding: 8px 12px;
                        border-radius: 15px;
                        background: ${isMyMessage ? '#007bff' : '#e9ecef'};
                        color: ${isMyMessage ? 'white' : 'black'};
                        text-align: left;
                    ">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">
                            <strong>${escapeHtml(message.sender_name || '–ê–Ω–æ–Ω–∏–º')}</strong>
                        </div>
                        <div>${escapeHtml(message.text)}</div>
                        <div style="font-size: 0.7em; opacity: 0.7; margin-top: 5px;">
                            ${new Date(message.created_at || new Date()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            ${message.is_read && isMyMessage ? ' ‚úì‚úì' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(messageElement);
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
            
            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç');
        }

    function showMessageNotification(message) {
        if ('Notification' in window && 
            Notification.permission === 'granted' &&
            message.sender_id !== currentUser?.id) {
            
            new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.sender_name}`, {
                body: message.text.length > 100 ? 
                    message.text.substring(0, 100) + '...' : 
                    message.text,
                icon: '/favicon.ico'
            });
        }
    }
    </script>

    <!-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û –ü–ï–†–ï–î </body> -->
    <script>
        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ö–µ–¥–µ—Ä–∞
        function showLogin() {
            document.getElementById('loginEmail').focus();
        }
        
        function toggleUserMenu() {
            alert('–ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º)');
        }
    </script>
</body>
</html>