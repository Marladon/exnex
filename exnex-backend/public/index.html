<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exnex</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input, textarea, select { 
            width: 100%; padding: 10px; margin: 10px 0; 
            border: 1px solid #ccc; border-radius: 4px; 
        }
        button { 
            padding: 10px 20px; background: #007bff; 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .ad-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .ad-price { color: #28a745; font-weight: bold; font-size: 1.2em; }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Exnex - –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>
        
        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="section">
            <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regName" placeholder="–ò–º—è">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="regResult" class="error"></div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="section">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <input type="number" id="adUserId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)">
            <select id="adCategory">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
            </select>
            <input type="text" id="adTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
            <textarea id="adDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
            <input type="number" id="adPrice" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="adLocation" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
            <input type="file" id="adImages" multiple accept="image/*">
            <div id="imagePreview" style="margin: 10px 0;"></div>
            <button onclick="createAd()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="adResult" class="error"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
        <div class="section">
            <h2>üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <button onclick="loadAds()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="adsContainer" class="ads-grid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let categories = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/categories`);
                const data = await res.json();
                categories = data.categories;
                const select = document.getElementById('adCategory');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const resultDiv = document.getElementById('regResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `–£—Å–ø–µ—à–Ω–æ! ID: ${data.user.id}`;
                    document.getElementById('adUserId').value = data.user.id;
                } else {
                    resultDiv.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        document.getElementById('adImages').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.margin = '5px';
                    img.style.borderRadius = '5px';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadImages(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('images', file);
            }
            
            try {
                const res = await fetch(`${API_URL}/upload/multiple`, {
                    method: 'POST',
                    body: formData
                    // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å boundary
                });
                const data = await res.json();
                return data.files.map(file => file.path);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
                return [];
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function createAd() {
            const files = document.getElementById('adImages').files;
            const resultDiv = document.getElementById('adResult');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...';
            resultDiv.style.color = 'blue';
            
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const imagePaths = files.length > 0 ? await uploadImages(files) : [];
                
                // 2. –°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                const ad = {
                    user_id: document.getElementById('adUserId').value,
                    category_id: document.getElementById('adCategory').value,
                    title: document.getElementById('adTitle').value,
                    description: document.getElementById('adDescription').value,
                    price: document.getElementById('adPrice').value,
                    location: document.getElementById('adLocation').value,
                    images: imagePaths  // –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
                };
                
                const res = await fetch(`${API_URL}/ads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ad)
                });
                
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! ID: ${data.ad.id}`;
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('adImages').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('adTitle').value = '';
                    document.getElementById('adDescription').value = '';
                    document.getElementById('adPrice').value = '';
                    document.getElementById('adLocation').value = '';
                    
                    loadAds();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function createAd() {
            const ad = {
                user_id: document.getElementById('adUserId').value,
                category_id: document.getElementById('adCategory').value,
                title: document.getElementById('adTitle').value,
                description: document.getElementById('adDescription').value,
                price: document.getElementById('adPrice').value,
                location: document.getElementById('adLocation').value
            };
            const resultDiv = document.getElementById('adResult');
            
            try {
                const res = await fetch(`${API_URL}/ads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ad)
                });
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! ID: ${data.ad.id}`;
                    loadAds();
                } else {
                    resultDiv.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadAds() {
            try {
                const res = await fetch(`${API_URL}/ads`);
                const data = await res.json();
                const container = document.getElementById('adsContainer');
                container.innerHTML = data.ads.map(ad => `
                    <div class="ad-card">
                        <h3>${ad.title}</h3>
                       ${ad.images && ad.images.length > 0 ? 
                        `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                        : ''}
                        <p>${ad.description}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', err);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadAds();
        });
    </script>
</body>
</html>