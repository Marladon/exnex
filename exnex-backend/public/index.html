<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exnex</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input, textarea, select { 
            width: 100%; padding: 10px; margin: 10px 0; 
            border: 1px solid #ccc; border-radius: 4px; 
        }
        button { 
            padding: 10px 20px; background: #007bff; 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .ad-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .ad-price { color: #28a745; font-weight: bold; font-size: 1.2em; }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Exnex - –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>
        
        <!-- –í—Ö–æ–¥ -->
        <div class="section">
            <h2>üîê –í—Ö–æ–¥</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="logout()" style="background: #dc3545;">–í—ã–π—Ç–∏</button>
            <div id="loginResult" class="error"></div>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="section">
            <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regName" placeholder="–ò–º—è">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="regResult" class="error"></div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="section">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <select id="adCategory">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
            </select>
            <input type="text" id="adTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
            <textarea id="adDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
            <input type="number" id="adPrice" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="adLocation" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
            <input type="file" id="adImages" multiple accept="image/*">
            <div id="imagePreview" style="margin: 10px 0;"></div>
            <button onclick="createAd()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="adResult" class="error"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
        <div class="section">
            <h2>üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <button onclick="loadAds()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="adsContainer" class="ads-grid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        let authToken = localStorage.getItem('token') || null;
        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        function setAuthToken(token, user = null) {
            authToken = token;
            if (token) {
                localStorage.setItem('token', token);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('user', JSON.stringify(user));
                }
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
            }
        }

        let categories = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/categories`);
                const data = await res.json();
                categories = data.categories;
                const select = document.getElementById('adCategory');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                if (res.ok) {
                    setAuthToken(data.token, data.user);
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü—Ä–∏–≤–µ—Ç, ${data.user.name}`;
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        function logout() {
            setAuthToken(null);
            document.getElementById('loginResult').textContent = '‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
            document.getElementById('adUserId').value = '';
            updateAuthUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                    üë§ ${currentUser.name} (${currentUser.email})<br>
                    üÜî ID: ${currentUser.id}
                `;
                userInfo.style.color = 'green';
            } else {
                userInfo.innerHTML = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                userInfo.style.color = 'red';
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const resultDiv = document.getElementById('regResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                
                const data = await res.json();
                if (res.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setAuthToken(data.token, data.user);
                    
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.name}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        document.getElementById('adImages').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.margin = '5px';
                    img.style.borderRadius = '5px';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadImages(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('images', file);
            }
            
            try {
                const res = await fetch(`${API_URL}/upload/multiple`, {
                    method: 'POST',
                    body: formData
                    // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å boundary
                });
                const data = await res.json();
                return data.files.map(file => file.path);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
                return [];
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function createAd() {
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø –° –ö–ê–†–¢–ò–ù–ö–ê–ú–ò ===');
            
            const files = document.getElementById('adImages').files;
            const resultDiv = document.getElementById('adResult');
            
            resultDiv.textContent = '–ù–∞—á–∏–Ω–∞–µ–º...';
            resultDiv.style.color = 'blue';
            
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                let imagePaths = [];
                
                if (files.length > 0) {
                    resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫...';
                    console.log('–ó–∞–≥—Ä—É–∂–∞—é', files.length, '–∫–∞—Ä—Ç–∏–Ω–æ–∫');
                    
                    const formData = new FormData();
                    for (let file of files) {
                        formData.append('images', file);
                    }
                    
                    const uploadRes = await fetch(`${API_URL}/upload/multiple`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadRes.ok) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏');
                    }
                    
                    const uploadData = await uploadRes.json();
                    console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', uploadData);
                    imagePaths = uploadData.files.map(file => file.path);
                }
                
                // 2. –°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
                resultDiv.textContent = '–°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...';
                
                const ad = {
                    category_id: document.getElementById('adCategory').value || 1,
                    title: document.getElementById('adTitle').value,
                    description: document.getElementById('adDescription').value,
                    price: parseFloat(document.getElementById('adPrice').value) || 0,
                    location: document.getElementById('adLocation').value,
                    images: imagePaths  // –º–∞—Å—Å–∏–≤ —Å –ø—É—Ç—è–º–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);
                
                const headers = {
                    'Content-Type': 'application/json'
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);

                const res = await fetch(`${API_URL}/ads`, {
                    method: 'POST',
                    headers: headers,  // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –æ–±—ä–µ–∫—Ç headers
                    body: JSON.stringify(ad)
                });
                
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! ID: ${data.ad.id}`;
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('adImages').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('adTitle').value = '';
                    document.getElementById('adDescription').value = '';
                    document.getElementById('adPrice').value = '';
                    document.getElementById('adLocation').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadAds();
                    
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
                
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
                console.error('–û—à–∏–±–∫–∞:', err);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadAds() {
            try {
                const res = await fetch(`${API_URL}/ads`);
                const data = await res.json();
                const container = document.getElementById('adsContainer');
                container.innerHTML = data.ads.map(ad => `
                    <div class="ad-card">
                        <h3>${ad.title}</h3>
                       ${ad.images && ad.images.length > 0 ? 
                        `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                        : ''}
                        <p>${ad.description}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', err);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
            
            updateAuthUI();  // ‚Üê –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            loadCategories();
            loadAds();
        });
    </script>
</body>
</html>