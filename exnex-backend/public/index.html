<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exnex</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input, textarea, select { 
            width: 100%; padding: 10px; margin: 10px 0; 
            border: 1px solid #ccc; border-radius: 4px; 
        }
        button { 
            padding: 10px 20px; background: #007bff; 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .ad-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .ad-price { color: #28a745; font-weight: bold; font-size: 1.2em; }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Exnex - –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>
        
        <!-- –í—Ö–æ–¥ -->
        <div class="section">
            <h2>üîê –í—Ö–æ–¥</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="logout()" style="background: #dc3545;">–í—ã–π—Ç–∏</button>
            <div id="loginResult" class="error"></div>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="section">
            <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regName" placeholder="–ò–º—è">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="regResult" class="error"></div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="section">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <select id="adCategory">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
            </select>
            <input type="text" id="adTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
            <textarea id="adDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
            <input type="number" id="adPrice" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="adLocation" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
            <input type="file" id="adImages" multiple accept="image/*">
            <div id="imagePreview" style="margin: 10px 0;"></div>
            <button onclick="createAd()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="adResult" class="error"></div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="section">
            <h2>üîç –ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                <input type="number" id="minPrice" placeholder="–¶–µ–Ω–∞ –æ—Ç">
                <input type="number" id="maxPrice" placeholder="–¶–µ–Ω–∞ –¥–æ">
                <input type="text" id="locationInput" placeholder="–ì–æ—Ä–æ–¥">
                <select id="categoryFilter">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
                <select id="sortSelect">
                    <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="cheapest">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                    <option value="expensive">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
                    <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                </select>
                <button onclick="searchAds()">–ò—Å–∫–∞—Ç—å</button>
                <button onclick="resetSearch()" style="background: #6c757d;">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
        <div class="section">
            <h2>üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <button onclick="loadAds()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <button onclick="loadFavorites()">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button onclick="loadAds()">üìã –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
            <div id="adsContainer" class="ads-grid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        let authToken = localStorage.getItem('token') || null;
        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        function setAuthToken(token, user = null) {
            authToken = token;
            if (token) {
                localStorage.setItem('token', token);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('user', JSON.stringify(user));
                }
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
            }
        }

        let categories = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/categories`);
                const data = await res.json();
                categories = data.categories;
                 
                // –î–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
                const select = document.getElementById('adCategory');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∏—Å–∫–∞
                const filterSelect = document.getElementById('categoryFilter');
                filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                if (res.ok) {
                    setAuthToken(data.token, data.user);
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü—Ä–∏–≤–µ—Ç, ${data.user.name}`;
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        function logout() {
            setAuthToken(null);
            document.getElementById('loginResult').textContent = '‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
            document.getElementById('adUserId').value = '';
            updateAuthUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                    üë§ ${currentUser.name} (${currentUser.email})<br>
                    üÜî ID: ${currentUser.id}
                `;
                userInfo.style.color = 'green';
            } else {
                userInfo.innerHTML = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                userInfo.style.color = 'red';
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const resultDiv = document.getElementById('regResult');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                
                const data = await res.json();
                if (res.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setAuthToken(data.token, data.user);
                    
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.name}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateAuthUI();
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        document.getElementById('adImages').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.margin = '5px';
                    img.style.borderRadius = '5px';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadImages(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('images', file);
            }
            
            try {
                const res = await fetch(`${API_URL}/upload/multiple`, {
                    method: 'POST',
                    body: formData
                    // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å boundary
                });
                const data = await res.json();
                return data.files.map(file => file.path);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
                return [];
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function createAd() {
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø –° –ö–ê–†–¢–ò–ù–ö–ê–ú–ò ===');
            
            const files = document.getElementById('adImages').files;
            const resultDiv = document.getElementById('adResult');
            
            resultDiv.textContent = '–ù–∞—á–∏–Ω–∞–µ–º...';
            resultDiv.style.color = 'blue';
            
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                let imagePaths = [];
                
                if (files.length > 0) {
                    resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫...';
                    console.log('–ó–∞–≥—Ä—É–∂–∞—é', files.length, '–∫–∞—Ä—Ç–∏–Ω–æ–∫');
                    
                    const formData = new FormData();
                    for (let file of files) {
                        formData.append('images', file);
                    }
                    
                    const uploadRes = await fetch(`${API_URL}/upload/multiple`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadRes.ok) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏');
                    }
                    
                    const uploadData = await uploadRes.json();
                    console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', uploadData);
                    imagePaths = uploadData.files.map(file => file.path);
                }
                
                // 2. –°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
                resultDiv.textContent = '–°–æ–∑–¥–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...';
                
                const ad = {
                    category_id: document.getElementById('adCategory').value || 1,
                    title: document.getElementById('adTitle').value,
                    description: document.getElementById('adDescription').value,
                    price: parseFloat(document.getElementById('adPrice').value) || 0,
                    location: document.getElementById('adLocation').value,
                    images: imagePaths  // –º–∞—Å—Å–∏–≤ —Å –ø—É—Ç—è–º–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);
                
                const headers = {
                    'Content-Type': 'application/json'
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', ad);

                const res = await fetch(`${API_URL}/ads`, {
                    method: 'POST',
                    headers: headers,  // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –æ–±—ä–µ–∫—Ç headers
                    body: JSON.stringify(ad)
                });
                
                const data = await res.json();
                if (res.ok) {
                    resultDiv.style.color = 'green';
                    resultDiv.textContent = `‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! ID: ${data.ad.id}`;
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('adImages').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('adTitle').value = '';
                    document.getElementById('adDescription').value = '';
                    document.getElementById('adPrice').value = '';
                    document.getElementById('adLocation').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadAds();
                    
                } else {
                    resultDiv.style.color = 'red';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                }
                
            } catch (err) {
                resultDiv.style.color = 'red';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
                console.error('–û—à–∏–±–∫–∞:', err);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadAds(filters = {}) {
            currentView = 'all';
            try {
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                const params = new URLSearchParams();
                
                if (filters.search) params.append('search', filters.search);
                if (filters.min_price) params.append('min_price', filters.min_price);
                if (filters.max_price) params.append('max_price', filters.max_price);
                if (filters.location) params.append('location', filters.location);
                if (filters.category_id) params.append('category_id', filters.category_id);
                if (filters.sort) params.append('sort', filters.sort);
                
                const queryString = params.toString();
                const url = queryString ? `${API_URL}/ads?${queryString}` : `${API_URL}/ads`;
                
                console.log('–ó–∞–≥—Ä—É–∂–∞—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –∞–¥—Ä–µ—Å—É:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π');
                }
                
                const container = document.getElementById('adsContainer');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                let favoritesMap = {};
                if (authToken) {
                    try {
                        const favRes = await fetch(`${API_URL}/favorites`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        if (favRes.ok) {
                            const favData = await favRes.json();
                            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É {adId: true} –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                            favData.favorites?.forEach(fav => {
                                favoritesMap[fav.id] = true;
                            });
                        }
                    } catch (err) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', err);
                    }
                }
                
                if (!data.ads || data.ads.length === 0) {
                    container.innerHTML = '<p>–û–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }
                
                container.innerHTML = data.ads.map(ad => `
                    <div class="ad-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>${ad.title}</h3>
                            <button onclick="toggleFavorite(${ad.id})" 
                                    id="fav-btn-${ad.id}" 
                                    style="background: none; border: none; font-size: 1.5em; cursor: pointer; 
                                        color: ${favoritesMap[ad.id] ? 'red' : 'gray'}">
                                ${favoritesMap[ad.id] ? '‚ô•' : '‚ô°'}
                            </button>
                        </div>
                        ${ad.images && ad.images.length > 0 ? 
                        `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                        : ''}
                        <p>${ad.description.substring(0, 100)}${ad.description.length > 100 ? '...' : ''}</p>
                        <div class="ad-price">${ad.price ? ad.price + ' ‚ÇΩ' : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'}</div>
                        <p><small>üìç ${ad.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</small></p>
                        <p><small>üë§ ${ad.user_name || '–ê–Ω–æ–Ω–∏–º'}</small></p>
                        <p><small>üìÅ ${ad.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</small></p>
                        <p><small>üëÅÔ∏è ${ad.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small></p>
                        <p><small>üìÖ ${new Date(ad.created_at).toLocaleDateString()}</small></p>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', err);
                const container = document.getElementById('adsContainer');
                container.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
            }
        }

        function searchAds() {
            const filters = {
                search: document.getElementById('searchInput').value,
                min_price: document.getElementById('minPrice').value,
                max_price: document.getElementById('maxPrice').value,
                location: document.getElementById('locationInput').value,
                category_id: document.getElementById('categoryFilter').value,
                sort: document.getElementById('sortSelect').value
            };
            
            loadAds(filters);
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortSelect').value = 'newest';
            
            loadAds(); // –∑–∞–≥—Ä—É–∂–∞–µ–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
            
            updateAuthUI();  // ‚Üê –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            loadCategories();
            loadAds();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function toggleFavorite(adId) {
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                return;
            }
            
            const button = document.getElementById(`fav-btn-${adId}`);
            
            try {
                const checkRes = await fetch(`${API_URL}/favorites/check/${adId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const checkData = await checkRes.json();
                
                if (checkData.is_favorite) {
                    // –£–¥–∞–ª—è–µ–º
                    const res = await fetch(`${API_URL}/favorites/${adId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        if (button) {
                            button.innerHTML = '‚ô°';
                            button.style.color = 'gray';
                        }
                        // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                        if (currentView === 'favorites') {
                            setTimeout(() => loadFavorites(), 100);
                        }
                    }
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º
                    const res = await fetch(`${API_URL}/favorites/${adId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        if (button) {
                            button.innerHTML = '‚ô•';
                            button.style.color = 'red';
                        }
                    }
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function loadFavorites() {
            currentView = 'favorites';
            if (!authToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/favorites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('adsContainer');
                container.innerHTML = '<h2>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>' + 
                    (data.favorites && data.favorites.length > 0 ? 
                        data.favorites.map(ad => `
                            <div class="ad-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3>${ad.title}</h3>
                                    <button onclick="toggleFavorite(${ad.id})" 
                                            style="color: red; background: none; border: none; font-size: 1.5em; cursor: pointer;">
                                        ‚ô•
                                    </button>
                                </div>
                                ${ad.images && ad.images.length > 0 ? 
                                `<img src="${ad.images[0]}" style="width:100%; height:150px; object-fit:cover; border-radius:5px; margin:10px 0;">` 
                                : ''}
                                <p>${ad.description.substring(0, 100)}${ad.description.length > 100 ? '...' : ''}</p>
                                <div class="ad-price">${ad.price ? ad.price + ' ‚ÇΩ' : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è'}</div>
                                <p><small>üìç ${ad.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</small></p>
                                <p><small>üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(ad.favorited_at).toLocaleDateString()}</small></p>
                            </div>
                        `).join('') :
                        '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }
    </script>
</body>
</html>